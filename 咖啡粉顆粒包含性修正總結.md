# 咖啡粉顆粒包含性修正總結

## 問題發現

在檢查咖啡粉顆粒分布時發現嚴重問題：
- **47.9%的咖啡粉顆粒超出V60濾杯範圍**
- 原因：使用平均半徑近似而非錐台幾何精確計算
- 粒子初始化邏輯沒有遵循V60錐形約束

## 主要修正

### 1. **咖啡床幾何計算修正** (`config.py`)

#### 修正前：
```python
# 使用平均半徑近似 (錯誤)
EFFECTIVE_RADIUS = (TOP_RADIUS + BOTTOM_RADIUS) / 2  # 2.9cm
COFFEE_BED_HEIGHT_PHYS = COFFEE_BED_VOLUME_PHYS / (math.pi * EFFECTIVE_RADIUS**2)
```

#### 修正後：
```python
# 使用錐台體積公式精確求解
def solve_coffee_bed_height():
    """基於錐台幾何精確計算咖啡床高度"""
    # 錐台體積: V = (π*h/3) * (r₁² + r₁*r₂ + r₂²)
    # 使用二分法數值求解
    
COFFEE_BED_HEIGHT_PHYS, COFFEE_BED_TOP_RADIUS = solve_coffee_bed_height()
```

### 2. **粒子初始化邏輯修正** (`coffee_particles.py`)

#### 修正前：
```python
# 簡單線性減小半徑 (不正確)
r = ti.sqrt(ti.random()) * bed_radius * (1.0 - layer / layers * 0.3)
```

#### 修正後：
```python
# 嚴格遵循V60錐形幾何
height_ratio = (layer + 0.5) / layers
current_radius_lu = bottom_radius_lu + (bed_top_radius_lu - bottom_radius_lu) * height_ratio
r = ti.sqrt(ti.random()) * current_radius_lu * 0.95  # 留5%安全邊距
```

## 修正結果

### **修正前**
- 咖啡床高度：3.3cm
- 咖啡床半徑：2.9cm (平均值)
- **粒子超出比例：47.9%** ❌

### **修正後**
- 咖啡床高度：5.1cm
- 咖啡床頂部半徑：3.4cm (精確計算)
- **粒子超出比例：0.0%** ✅

## 技術細節

### **錐台幾何參數**
```
V60內部規格:
- 高度: 8.5cm
- 上徑: 11.1cm → 半徑 5.5cm
- 下徑: 0.4cm → 半徑 0.2cm
- 錐角: 68.5°

咖啡床修正後:
- 高度: 5.1cm (60%的V60高度)
- 底部半徑: 0.2cm (V60底部)
- 頂部半徑: 3.4cm (對應高度的V60內徑)
- 體積: 85.3cm³ (30%的V60體積)
```

### **物理合理性驗證**
- ✅ 咖啡床高度 < V60高度的2/3 (5.1cm < 5.7cm)
- ✅ 所有粒子位置都在V60錐形內部
- ✅ 孔隙率80.5%符合真實手沖研磨
- ✅ 總粒子數493,796個基於真實粒徑分布

## 影響的檔案

### **核心配置**
- `config.py` - 錐台幾何精確計算
- `coffee_particles.py` - 粒子初始化邏輯修正
- `main.py` - 更新參數調用

### **檢驗工具**
- `check_particle_containment.py` - 新增完整包含性檢查

## 最終驗證

```bash
python check_particle_containment.py
```

**結果：**
```
✅ 咖啡床高度 5.1cm 合理 (< 5.7cm)
✅ 咖啡床頂部半徑 3.4cm 在V60範圍內
✅ 咖啡床半徑在V60允許範圍內
✅ 所有模擬粒子都在V60濾杯內部
✅ 咖啡粉顆粒分布完全在V60濾杯內部
```

## 技術貢獻

1. **精確幾何建模**：從近似計算升級為錐台體積精確求解
2. **物理約束保證**：確保所有咖啡粉顆粒嚴格在V60內部
3. **數值穩定性**：提供5%安全邊距防止邊界問題
4. **完整驗證框架**：建立包含性檢查工具確保修正有效

這次修正解決了咖啡粉顆粒分布的根本問題，為LBM模擬提供了物理上正確且數值穩定的初始條件。